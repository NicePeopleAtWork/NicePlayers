<!DOCTYPE html>
<html>
<head>
  <title>Youbora ChromeCast Demo</title>
  <script type="text/javascript" src="//www.gstatic.com/cv/js/sender/v1/cast_sender.js"></script>
  <script type="text/javascript" src="//www.gstatic.com/cast/js/receiver/1.0/cast_receiver.js"></script>
  <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
</head>
<body>
  <form>
    <button type="button" id="castme">Click To Cast</button>
    <button type="button" id="stop">Click To Exit</button>
    <br>
    <span>Media Commands: </span><br>
    <button type="button" id="play">Play</button><br>
    <button type="button" id="pause">Pause</button> <br>
    Progress: <input id="progress" type="range" min="1" max="100" value="1" step="1" onmouseup="castWorkflow.app.seek.to(this.value);"> <br>
  </form>
  <script type="text/javascript">
    //CHROMECAST WORKFLOW
    $( document ).ready(function(){
        var loadCastInterval = setInterval(function(){
          if (chrome.cast.isAvailable) {
            console.log('CAST is present.');
            clearInterval(loadCastInterval);
            castWorkflow.init.load();
          } else {
            console.log('CAST still not present!');
          }
        },1000);
    });
    var castWorkflow = {
      appId: "",
      session: false,
      appiConfig: {},
      playTime: {},
      setEvents: function () {
        $('#castme').click(function(){ castWorkflow.app.launch(); });
        $('#stop').click(function(){ castWorkflow.app.stop(); });
        $('#pause').click(function(){ castWorkflow.app.pause(); });
        $('#play').click(function(){ castWorkflow.app.play(); });
      },
      init: {
        load: function () {
          castWorkflow.apiConfig = new chrome.cast.ApiConfig(new chrome.cast.SessionRequest("26612C15"), castWorkflow.session.listener, castWorkflow.receiver.listener);
          chrome.cast.initialize(castWorkflow.apiConfig, castWorkflow.init.created, castWorkflow.init.failed);
        },
        created: function () {
          console.log('CAST initialization done!')
          castWorkflow.setEvents();
        },
        failed: function () {
          console.log('CAST initialization failure!')
        },
      },
      session: {
        listener: function (e) { castWorkflow.session = e; }
      },
      media: {
        load: function () {
          if (!castWorkflow.session) { console.log("No session."); return; }
          castWorkflow.session.addMediaListener(castWorkflow.media.events.bind(this, 'addMediaListener'));
          var mediaInfo = new chrome.cast.media.MediaInfo('http://mirrorblender.top-ix.org/movies/sintel-1024-surround.mp4');
          mediaInfo.contentType = 'video/mp4';
          var request = new chrome.cast.media.LoadRequest(mediaInfo);
          request.autoplay = true;
          castWorkflow.session.loadMedia(request, castWorkflow.media.loaded.bind(this, 'loadMedia'), castWorkflow.media.failed);
        },
        loaded: function (how, media) {
          console.log('Loaded video to CAST!');
          media.addUpdateListener(castWorkflow.media.events);
          castWorkflow.session.addMediaListener(castWorkflow.media.events);
          castWorkflow.playTime = setInterval(function () {
            var request = new chrome.cast.media.GetStatusRequest();
            castWorkflow.session.media[0].status(request, castWorkflow.media.checkTime, castWorkflow.media.checkTime);
          } , 2000 );
        },
        failed: function () {
          console.log('Unable to load video to CAST!');
        },
        events: function (e, a) {
          console.log(e)
          console.log(a)
        },
        checkTime: function (media) {
          console.log(media)
          console.log('CheckTime: ' + castWorkflow.session.media[0].currentTime)
        }
      },
      app: {
        launch: function () {
          console.log("Launching the Chromecast App...");
          chrome.cast.requestSession(castWorkflow.app.created ,castWorkflow.app.failed);
        },
        created: function (e) {
          castWorkflow.session = e;
          castWorkflow.session.addMediaListener(castWorkflow.media.events.bind(this, 'addMediaListener'));
          castWorkflow.media.load();
        },
        failed: function () {
          console.log('Unable to create CAST session!');
        },
        play: function () {
          console.log('--> Play');
          castWorkflow.session.media[0].play();
          castWorkflow.sendEvent(NiceAbstractPluginEvents.PLAY);
        },
        pause: function () {
          console.log('--> Pause');
          castWorkflow.session.media[0].pause();
          castWorkflow.sendEvent(NiceAbstractPluginEvents.PAUSE);
        },
        stop: function () {
          console.log('--> Stop');
          castWorkflow.session.stop();
          castWorkflow.sendEvent(NiceAbstractPluginEvents.STOP);
        },
        seek: {
          to: function (pos) {
            console.log('--> Seek');
            var request = new chrome.cast.media.SeekRequest();
            request.currentTime = pos * castWorkflow.session.media[0].media.duration / 100;
            console.log(request);
            castWorkflow.session.media[0].seek(request, castWorkflow.app.seek.done, castWorkflow.app.seek.error);
            castWorkflow.sendEvent(NiceAbstractPluginEvents.SEEK_INIT);

          },
          done: function () {
            console.log('--> Seek Done');
            console.log(castWorkflow.session.media[0]);
            castWorkflow.sendEvent(NiceAbstractPluginEvents.SEEK_END);
          },
          error: function () {
            console.log('--> Seek Failure');
            console.log(castWorkflow.session.media[0]);
            castWorkflow.sendEvent(NiceAbstractPluginEvents.SEEK_END);
          }
        }
      },
      receiver: {
        listener: function (e) {
          //console.log("receiver listener "+e);
          if( e === 'available' ) { console.log("Chromecast was found on the network."); }
          else { console.log("There are no Chromecasts available."); }
        }
      },
      sendEvent: function(event) {
        var event = new CustomEvent(event, { bubbles: true, cancelable: true });
        document.dispatchEvent(event);
      }
    }
    var receiver = new cast.receiver.Receiver("26612C15", "NPAW");
    var channelHandler = new cast.receiver.ChannelHandler("NPAW");
    channelHandler.addChannelFactory(receiver.createChannelFactory("NPAW"));
    channelHandler.addEventListener('error', function($e){ console.log('JAC - Error!'); });
    channelHandler.addEventListener('open', function($e){ console.log('JAC - OnOpen!'); });
    channelHandler.addEventListener('message', function($e){ console.log('JAC - Message: ' + $e.type); });


    receiver.start();
  </script>
</body>
</html>
