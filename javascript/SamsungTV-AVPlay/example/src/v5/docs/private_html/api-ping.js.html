
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: api-ping.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
    <link type="text/css" rel="stylesheet" href="styles.css">
</head>

<body>

    <div id="main">

        <h1 class="page-title">Source: api-ping.js</h1>

        



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @license
 * Youbora PingApi
 * Copyright NicePopleAtWork &lt;http://nicepeopleatwork.com/>
 */

/**
 * Instances of this class will call a callback every setted interval.
 *
 * @class
 * @memberof $YB
 * @param {$YB.plugins.Generic} plugin The plugin from where it was called.
 */
$YB.api.Ping = function(plugin) {
    try {
        this.plugin = plugin;
        this.interval = 5000;
        this.isRunning = false;
        this.timer = null;

        this.chrono = new $YB.utils.Chrono();

        /** An array of key-value pairs of entities changed to be sent in pings. */
        this.changedEntities = [];

        /** Last rendition sent. */
        this.lastRendition = '';

    } catch (err) {
        $YB.error(err);
    }
};

/**
 * Starts the timer.
 */
$YB.api.Ping.prototype.start = function() {
    try {
        this.isRunning = true;
        this._setPing();

        $YB.notice("Sending pings every " + this.interval + "ms.", 'darkgreen');
    } catch (err) {
        $YB.error(err);
    }
};

/**
 * Stops the timer.
 */
$YB.api.Ping.prototype.stop = function() {
    try {
        this.isRunning = false;
        clearTimeout(this.timer);
    } catch (err) {
        $YB.error(err);
    }
};

$YB.api.Ping.prototype._setPing = function() {
    try {
        if (this.isRunning) {
            this.chrono.start();
            var context = this;
            this.timer = setTimeout(function() {
                context.sendPing({
                    diffTime: context.chrono.stop()
                });
                context._setPing();
            }, this.interval);
        }
    } catch (err) {
        $YB.error(err);
    }
};

/**
 * Sends '/ping' request.
 *
 * @param {Object} [params] Any parameter specified in this object will be sent along the AJAX request. The API will try to populate every param, so use this only if you need to override a specific param. Refer to the NQS API for more information.
 * @param {function} [callback] If defined, this callback will be called when de AJAX request is done successfully.
 */
$YB.api.Ping.prototype.sendPing = function(params, callback) {
    try {
        params = params || {};

        // Params
        params.time = typeof params.time != 'undefined' ? params.time : this.plugin.infoApi.getPlayhead();
        params.bitrate = typeof params.bitrate != 'undefined' ? params.bitrate : this.plugin.infoApi.getBitrate();
        params.throughput = typeof params.throughput != 'undefined' ? params.throughput : this.plugin.infoApi.getThroughput();
        params.totalBytes = typeof params.totalBytes != 'undefined' ? params.totalBytes : this.plugin.infoApi.getTotalBytes();
        params.pingTime = typeof params.pingTime != 'undefined' ? params.pingTime : this.plugin.comm.pingTime;

        // Rendition
        var rendition = this.plugin.infoApi.getRendition();
        if (this.lastRendition != rendition) {
            this.sendChangeEntity('rendition', rendition);
            this.lastRendition = rendition;
        }

        // Changed entities
        if (this.changedEntities.length == 1) {
            var ent = this.changedEntities.shift();
            params.entityType = typeof params.entityType != 'undefined' ? params.entityType : ent.key;
            params.entityValue = typeof params.entityValue != 'undefined' ? params.entityValue : ent.value;
        } else if (this.changedEntities.length > 1) {
            var obj = {};
            while (this.changedEntities.length > 0) {
                var ent = this.changedEntities.shift();
                obj[ent.key] = ent.value;
            }

            params.entityValue = typeof params.entityValue != 'undefined' ? params.entityValue : JSON.stringify(obj);
        }

        // Ads
        if (this.plugin.adnalyzer &amp;&amp; this.plugin.isShowingAds) {
            params.adPlayhead = typeof params.adPlayhead != 'undefined' ? params.adPlayhead : this.plugin.infoApi.getAdPlayhead();
            params.adBitrate = typeof params.adBitrate != 'undefined' ? params.adBitrate : this.plugin.infoApi.getAdBitrate();
        }

        // Send request
        this.plugin.comm.sendRequest('/ping', params, callback);

    } catch (err) {
        $YB.error(err);
    }
};

/**
 * Queues an entity that would be changed during the next ping.
 * @param {string} key Name of the entity. If the key is already queued to change, it will be overriden. ie: duration, rendition...
 * @param {mixed} value New value.
 */
$YB.api.Ping.prototype.sendChangeEntity = function(key, value) {
    try {
        this.changedEntities.push({ key: key, value: value });
    } catch (err) {
        $YB.error(err);
    }
};
</code></pre>
        </article>
    </section>




    </div>

    <nav>
        <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="$YB.adnalyzers.Generic.html">$YB.adnalyzers.Generic</a></li><li><a href="$YB.api.Ads.html">$YB.api.Ads</a></li><li><a href="$YB.api.Info.html">$YB.api.Info</a></li><li><a href="$YB.api.Ping.html">$YB.api.Ping</a></li><li><a href="$YB.api.Video.html">$YB.api.Video</a></li><li><a href="$YB.comm.AjaxRequest.html">$YB.comm.AjaxRequest</a></li><li><a href="$YB.comm.Communication.html">$YB.comm.Communication</a></li><li><a href="$YB.data.Options.html">$YB.data.Options</a></li><li><a href="$YB.plugins.Generic.html">$YB.plugins.Generic</a></li><li><a href="$YB.services.ResourceParser.html">$YB.services.ResourceParser</a></li><li><a href="$YB.utils.Buffer.html">$YB.utils.Buffer</a></li><li><a href="$YB.utils.Chrono.html">$YB.utils.Chrono</a></li></ul><h3>Namespaces</h3><ul><li><a href="$YB.html">$YB</a></li><li><a href="$YB.adnalyzers.html">$YB.adnalyzers</a></li><li><a href="$YB.api.html">$YB.api</a></li><li><a href="$YB.comm.html">$YB.comm</a></li><li><a href="$YB.data.html">$YB.data</a></li><li><a href="$YB.plugins.html">$YB.plugins</a></li><li><a href="$YB.services.html">$YB.services</a></li><li><a href="$YB.utils.html">$YB.utils</a></li></ul>
    </nav>

    <div class="clear"></div>
    <footer>
        Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Fri Apr 22 2016 09:34:52 GMT+0200 (CEST)
    </footer>

    <script> prettyPrint(); </script>
    <script src="scripts/linenumber.js"> </script>
</body>
</html>