
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: api-video.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
    <link type="text/css" rel="stylesheet" href="styles.css">
</head>

<body>

    <div id="main">

        <h1 class="page-title">Source: api-video.js</h1>

        



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @license
 * Youbora VideoApi
 * Copyright NicePopleAtWork &lt;http://nicepeopleatwork.com/>
 */

/** VideoApi will help plugin class in the tracking and analyzing the Video events.
 *
 * @class
 * @memberof $YB
 * @param {$YB.plugins.Generic} plugin The plugin from where it was called.
 */
$YB.api.Video = function(plugin) { // constructor
    this.plugin = plugin;

    /** An instance of {@link $YB.utils.Buffer}. */
    this.buffer = new $YB.utils.Buffer(this);

    /** An object with multiples instances of {@link $YB.utils.Chrono}.
     * @prop {$YB.utils.Chrono} seek Chrono for seeks.
     * @prop {$YB.utils.Chrono} pause Chrono for pauses.
     * @prop {$YB.utils.Chrono} joinTime Chrono between start and joinTime.
     * @prop {$YB.utils.Chrono} buffer Reference to this.buffer.chrono
     */
    this.chrono = {
        seek: new $YB.utils.Chrono(),
        pause: new $YB.utils.Chrono(),
        joinTime: new $YB.utils.Chrono(),
        genericAd: new $YB.utils.Chrono(),
        buffer: this.buffer.chrono
    };

    /** Last duration sent. */
    this.lastDuration = 0;
};

/**
 * Sends '/start' request.
 *
 * @param {Object} [params] Any parameter specified in this object will be sent along the AJAX request. The API will try to populate every param, so use this only if you need to override a specific param. Refer to the NQS API for more information.
 * @param {function} [callback] If defined, this callback will be called when de AJAX request is done successfully.
 */
$YB.api.Video.prototype.sendStart = function(params, callback) {
    try {
        if (this.plugin.isStartSent) { // If there's a previous view, close it
            this.sendStop();
        }

        if (this.plugin.data.parseCDNNodeHost || this.plugin.data.parseHLS) {
            this.plugin.resourceParser.init();
        }

        this.plugin.isStartSent = true;

        this.chrono.joinTime.start();
        this.plugin.pingApi.start();

        this._consolidateTitle();

        params = params || {};

        // Params
        params.system = typeof params.system != 'undefined' ? params.system : this.plugin.data.accountCode;
        params.player = typeof params.player != 'undefined' ? params.player : this.plugin.pluginName;
        params.user = typeof params.user != 'undefined' ? params.user : this.plugin.data.username;
        params.transcode = typeof params.transcode != 'undefined' ? params.transcode : this.plugin.data.transactionCode;
        params.hashTitle = typeof params.hashTitle != 'undefined' ? params.hashTitle : this.plugin.data.hashTitle;
        params.referer = typeof params.referer != 'undefined' ? params.referer : (typeof window != 'undefined') ? window.location.href : '';

        // Device
        params.deviceId = typeof params.deviceId != 'undefined' ? params.deviceid : this.plugin.data.device.id;

        // Plugin versioning
        params.pluginVersion = typeof params.pluginVersion != 'undefined' ? params.pluginVersion : this.plugin.pluginVersion;
        params.playerVersion = typeof params.playerVersion != 'undefined' ? params.playerVersion : this.plugin.infoApi.getPlayerVersion();

        // Media
        params.resource = typeof params.resource != 'undefined' ? params.resource : this.plugin.infoApi.getResource();
        params.duration = typeof params.duration != 'undefined' ? params.duration : this.plugin.infoApi.getMediaDuration();
        params.live = typeof params.live != 'undefined' ? params.live : this.plugin.infoApi.getIsLive();
        params.rendition = typeof params.rendition != 'undefined' ? params.rendition : this.plugin.infoApi.getRendition();
        params.title = typeof params.title != 'undefined' ? params.title : this.plugin.infoApi.getTitle();
        params.properties = typeof params.properties != 'undefined' ? params.properties : this.plugin.data.properties;
        params.cdn = typeof params.cdn != 'undefined' ? params.cdn : this.plugin.data.media.cdn;

        // Network
        params.isp = typeof params.isp != 'undefined' ? params.isp : this.plugin.data.network.isp;
        params.ip = typeof params.ip != 'undefined' ? params.ip : this.plugin.data.network.ip;

        // Extra Params
        params.param1 = typeof params.param1 != 'undefined' ? params.param1 : this.plugin.data.extraParams.param1;
        params.param2 = typeof params.param2 != 'undefined' ? params.param2 : this.plugin.data.extraParams.param2;
        params.param3 = typeof params.param3 != 'undefined' ? params.param3 : this.plugin.data.extraParams.param3;
        params.param4 = typeof params.param4 != 'undefined' ? params.param4 : this.plugin.data.extraParams.param4;
        params.param5 = typeof params.param5 != 'undefined' ? params.param5 : this.plugin.data.extraParams.param5;
        params.param6 = typeof params.param6 != 'undefined' ? params.param6 : this.plugin.data.extraParams.param6;
        params.param7 = typeof params.param7 != 'undefined' ? params.param7 : this.plugin.data.extraParams.param7;
        params.param8 = typeof params.param8 != 'undefined' ? params.param8 : this.plugin.data.extraParams.param8;
        params.param9 = typeof params.param9 != 'undefined' ? params.param9 : this.plugin.data.extraParams.param9;
        params.param10 = typeof params.param10 != 'undefined' ? params.param10 : this.plugin.data.extraParams.param10;

        // Ping-related
        params.totalBytes = typeof params.totalBytes != 'undefined' ? params.totalBytes : this.plugin.infoApi.getTotalBytes();
        params.pingTime = typeof params.pingTime != 'undefined' ? params.pingTime : this.plugin.comm.pingTime;

        // Ads
        params.adsExpected = typeof params.adsExpected != 'undefined' ? params.adsExpected : this.plugin.data.ads.expected;

        // CDN Node Host
        if (this.plugin.data.parseCDNNodeHost) {
            params.nodeHost = typeof params.nodeHost != 'undefined' ? params.nodeHost : this.plugin.resourceParser.cdnHost;
            params.nodeType = typeof params.nodeType != 'undefined' ? params.nodeType : this.plugin.resourceParser.cdnType;
        }

        // Resumer
        if (this.plugin.resumeService &amp;&amp; this.plugin.data.resumeConfig.enabled) { // If Resume service is enabled
            this.plugin.resumeService.start();
            params.isResumed = this.plugin.resumeService.isResumed;
        }

        // isBalanced
        if (this.plugin.data.isBalanced == 1) {
            params.isBalanced = 1;
        }

        // isResumed
        if (this.plugin.data.isResumed == 1) {
            params.isResumed = 1;
        }

        // Send the request
        this.plugin.comm.nextView(params.live);
        this.plugin.comm.sendRequest('/start', params, callback);
        $YB.notice("Request: NQS /start " + params.resource, 'darkgreen');

        // Save last info sent
        this.lastDuration = params.duration;
    } catch (err) {
        $YB.error(err);
    }
};

$YB.api.Video.prototype._consolidateTitle = function() {
    try {
        if (this.plugin.data.properties.content_metadata) {
            this.plugin.data.properties.content_metadata.title = this.plugin.infoApi.getTitle();
        } else {
            this.plugin.data.properties.content_metadata = {
                title: this.plugin.infoApi.getTitle()
            };
        }
    } catch (err) {
        $YB.error(err);
    }
};


/**
 * Sends '/joinTime' request.
 *
 * @param {Object} [params] Any parameter specified in this object will be sent along the AJAX request. The API will try to populate every param, so use this only if you need to override a specific param. Refer to the NQS API for more information.
 * @param {function} [callback] If defined, this callback will be called when de AJAX request is done successfully.
 */
$YB.api.Video.prototype.sendJoin = function(params, callback) {
    try {
        if (this.plugin.isStartSent &amp;&amp; !this.plugin.isJoinSent &amp;&amp; (!this.plugin.adnalyzer || !this.plugin.adnalyzer.isAdStartSent)) {
            this.plugin.isJoinSent = true;

            if (this.buffer.autostart) {
                this.buffer.start();
            }

            params = params || {};
            params.time = typeof params.time != 'undefined' ? params.time : this.chrono.joinTime.getDeltaTime();
            params.eventTime = typeof params.eventTime != 'undefined' ? params.eventTime : this.plugin.infoApi.getPlayhead();
            params.mediaDuration = typeof params.mediaDuration != 'undefined' ? params.mediaDuration : this.plugin.infoApi.getMediaDuration();

            // Check duration to send it only once
            if (params.mediaDuration === this.lastDuration) {
                delete params.mediaDuration;
            }

            //Substract preroll time from time
            if (this.plugin.adnalyzer &amp;&amp; this.plugin.adnalyzer.adsApi.totalPrerollTime > 0) {
                params.time = params.time - this.plugin.adnalyzer.adsApi.totalPrerollTime;
                if (params.time &lt; 0) params.time = 1;
                this.plugin.adnalyzer.adsApi.totalPrerollTime = 0;
            }

            // Send the request
            this.plugin.comm.sendRequest('/joinTime', params, callback);
            $YB.notice("Request: NQS /joinTime " + params.time + "ms", 'darkgreen');
        }
    } catch (err) {
        $YB.error(err);
    }
};

/**
 * Sends '/stop' request.
 *
 * @param {Object} [params] Any parameter specified in this object will be sent along the AJAX request. The API will try to populate every param, so use this only if you need to override a specific param. Refer to the NQS API for more information.
 * @param {function} [callback] If defined, this callback will be called when de AJAX request is done successfully.
 */
$YB.api.Video.prototype.sendStop = function(params, callback) {
    try {
        if (this.plugin.isStartSent) {
            this.plugin.isStartSent = false;
            this.plugin.isPaused = false;
            this.plugin.isJoinSent = false;
            this.plugin.isSeeking = false;
            this.plugin.isBuffering = false;

            this.plugin.resourceParser.clear();

            this.plugin.pingApi.stop();
            this.buffer.stop();

            if (this.plugin.adnalyzer) {
                this.plugin.adnalyzer.adsApi.resetNumbers();
            }

            params = params || {};
            params.diffTime = typeof params.diffTime != 'undefined' ? params.diffTime : this.plugin.pingApi.chrono.getDeltaTime();

            // Send the request
            this.plugin.comm.sendRequest('/stop', params, callback);
            $YB.notice("Request: NQS /stop", 'darkgreen');

            // If Resume service is enabled
            if ($YB.services.Resume &amp;&amp; this.plugin.data.resumeConfig.enabled) {
                this.plugin.resumeService.sendPlayTime();
            }
        }
    } catch (err) {
        $YB.error(err);
    }
};


/**
 * Sends '/pause' request.
 *
 * @param {Object} [params] Any parameter specified in this object will be sent along the AJAX request. The API will try to populate every param, so use this only if you need to override a specific param. Refer to the NQS API for more information.
 * @param {function} [callback] If defined, this callback will be called when de AJAX request is done successfully.
 */
$YB.api.Video.prototype.sendPause = function(params, callback) {
    try {
        if (this.plugin.isJoinSent &amp;&amp; !this.plugin.isPaused) {
            this.plugin.isPaused = true;
            this.chrono.pause.start();

            // Send the request
            this.plugin.comm.sendRequest('/pause', params, callback);
            $YB.notice("Request: NQS /pause", 'darkgreen');

            if ($YB.services.Resume &amp;&amp; this.plugin.data.resumeConfig.enabled) { // If Resume service is enabled
                this.plugin.resumeService.sendPlayTime();
            }
        }
    } catch (err) {
        $YB.error(err);
    }
};


/**
 * Sends '/resume' request.
 *
 * @param {Object} [params] Any parameter specified in this object will be sent along the AJAX request. The API will try to populate every param, so use this only if you need to override a specific param. Refer to the NQS API for more information.
 * @param {function} [callback] If defined, this callback will be called when de AJAX request is done successfully.
 */
$YB.api.Video.prototype.sendResume = function(params, callback) {
    try {
        if (this.plugin.isJoinSent &amp;&amp; this.plugin.isPaused) {
            this.plugin.isPaused = false;
            this.chrono.pause.getDeltaTime();

            // Send the request
            this.plugin.comm.sendRequest('/resume', params, callback);
            $YB.notice("Request: NQS /resume", 'darkgreen');
        }
    } catch (err) {
        $YB.error(err);
    }
};

/** Notifies a buffer start. It will expect a {$YB.api.Video#sendBufferEnd}. */
$YB.api.Video.prototype.sendBufferStart = function() {
    try {
        if (this.plugin.isJoinSent &amp;&amp; !this.plugin.isBuffering) {
            this.plugin.isBuffering = true;
            this.chrono.buffer.start();

            $YB.notice("Method: /bufferStart", 'darkgreen');
        }
    } catch (err) {
        $YB.error(err);
    }
};

/**
 * Sends '/bufferUnderrun' request.
 *
 * @param {Object} [params] Any parameter specified in this object will be sent along the AJAX request. The API will try to populate every param, so use this only if you need to override a specific param. Refer to the NQS API for more information.
 * @param {function} [callback] If defined, this callback will be called when de AJAX request is done successfully.
 */
$YB.api.Video.prototype.sendBufferEnd = function(params, callback) {
    try {
        if (this.plugin.isJoinSent &amp;&amp; this.plugin.isBuffering) {

            this.plugin.isBuffering = false;

            params = params || {};
            params.duration = typeof params.duration != 'undefined' ? params.duration : this.chrono.buffer.getDeltaTime();
            params.time = typeof params.time != 'undefined' ? params.time : this.plugin.infoApi.getPlayhead();

            if (this.plugin.infoApi.getIsLive() &amp;&amp; params.time === 0) {
                params.time = 1; // Buffer does not support 0 in time parameter.
            }

            // Send the request
            this.plugin.comm.sendRequest('/bufferUnderrun', params, callback);
            $YB.notice("Request: NQS /bufferUnderrun " + params.duration + "ms", 'darkgreen');
        }
    } catch (err) {
        $YB.error(err);
    }
};

/**
 * Sends '/error' request.
 *
 * @param {Object} [params] Any parameter specified in this object will be sent along the AJAX request. The API will try to populate every param, so use this only if you need to override a specific param. Refer to the NQS API for more information.
 * @param {function} [callback] If defined, this callback will be called when de AJAX request is done successfully.
 */
$YB.api.Video.prototype.sendError = function(params, callback) {
    try {
        this._consolidateTitle();

        // stop pings and nicebuffer
        this.plugin.pingApi.stop();
        this.buffer.stop();

        params = params || {};

        // Message &amp; Errorcode
        params.msg = typeof params.msg != 'undefined' ? params.msg : 'Unknown Error';
        if (typeof params.errorCode == 'undefined' || parseInt(params.errorCode) &lt; 0) {
            params.errorCode = 9000;
        }

        // Params
        params.system = typeof params.system != 'undefined' ? params.system : this.plugin.data.accountCode;
        params.player = typeof params.player != 'undefined' ? params.player : this.plugin.pluginName;
        params.hashTitle = typeof params.hashTitle != 'undefined' ? params.hashTitle : this.plugin.data.hashTitle;
        params.user = typeof params.user != 'undefined' ? params.user : this.plugin.data.username;
        params.transcode = typeof params.transcode != 'undefined' ? params.transcode : this.plugin.data.transactionCode;
        params.referer = typeof params.referer != 'undefined' ? params.referer : (typeof window != 'undefined') ? window.location.href : '';

        // Device
        params.deviceId = typeof params.deviceId != 'undefined' ? params.deviceid : this.plugin.data.device.id;

        // Plugin versioning
        params.pluginVersion = typeof params.pluginVersion != 'undefined' ? params.pluginVersion : this.plugin.pluginVersion;
        params.playerVersion = typeof params.playerVersion != 'undefined' ? params.playerVersion : this.plugin.infoApi.getPlayerVersion();

        // Media
        params.resource = typeof params.resource != 'undefined' ? params.resource : this.plugin.infoApi.getResource();
        params.duration = typeof params.duration != 'undefined' ? params.duration : this.plugin.infoApi.getMediaDuration();
        params.live = typeof params.live != 'undefined' ? params.live : this.plugin.infoApi.getIsLive();
        params.rendition = typeof params.rendition != 'undefined' ? params.rendition : this.plugin.infoApi.getRendition();
        params.title = typeof params.title != 'undefined' ? params.title : this.plugin.infoApi.getTitle();
        params.properties = typeof params.properties != 'undefined' ? params.properties : this.plugin.data.properties;
        params.cdn = typeof params.cdn != 'undefined' ? params.cdn : this.plugin.data.media.cdn;

        // Network
        params.isp = typeof params.isp != 'undefined' ? params.isp : this.plugin.data.network.isp;
        params.ip = typeof params.ip != 'undefined' ? params.ip : this.plugin.data.network.ip;

        // Extra params
        params.param1 = typeof params.param1 != 'undefined' ? params.param1 : this.plugin.data.extraParams.param1;
        params.param2 = typeof params.param2 != 'undefined' ? params.param2 : this.plugin.data.extraParams.param2;
        params.param3 = typeof params.param3 != 'undefined' ? params.param3 : this.plugin.data.extraParams.param3;
        params.param4 = typeof params.param4 != 'undefined' ? params.param4 : this.plugin.data.extraParams.param4;
        params.param5 = typeof params.param5 != 'undefined' ? params.param5 : this.plugin.data.extraParams.param5;
        params.param6 = typeof params.param6 != 'undefined' ? params.param6 : this.plugin.data.extraParams.param6;
        params.param7 = typeof params.param7 != 'undefined' ? params.param7 : this.plugin.data.extraParams.param7;
        params.param8 = typeof params.param8 != 'undefined' ? params.param8 : this.plugin.data.extraParams.param8;
        params.param9 = typeof params.param9 != 'undefined' ? params.param9 : this.plugin.data.extraParams.param9;
        params.param10 = typeof params.param10 != 'undefined' ? params.param10 : this.plugin.data.extraParams.param10;

        // CDN Node Host
        if (this.plugin.data.parseCDNNodeHost) {
            params.nodeHost = typeof params.nodeHost != 'undefined' ? params.nodeHost : this.plugin.resourceParser.cdnHost;
            params.nodeType = typeof params.nodeType != 'undefined' ? params.nodeType : this.plugin.resourceParser.cdnType;
        }

        // Resumer
        if ($YB.services.Resume &amp;&amp; this.plugin.data.resumeConfig.enabled) { // If Resume service is enabled
            this.plugin.resumeService.start();
            params.isResumed = this.plugin.resumeService.isResumed;
        }

        // isBalanced
        if (this.plugin.data.isBalanced == 1) {
            params.isBalanced = 1;
        }

        // isResumed
        if (this.plugin.data.isResumed == 1) {
            params.isResumed = 1;
        }

        // Send the request
        this.plugin.comm.sendRequest('/error', params, callback);
        $YB.notice("Request: NQS /error " + params.msg, 'darkgreen');
    } catch (err) {
        $YB.error(err);
    }
};

/** Notifies a seek start. It will expect a {$YB.api.Video#sendSeekEnd}. */
$YB.api.Video.prototype.sendSeekStart = function() {
    try {
        if (this.plugin.isJoinSent &amp;&amp; !this.plugin.isSeeking) {
            this.plugin.isSeeking = true;
            this.chrono.seek.start();

            $YB.notice("Method: /seekStart", 'darkgreen');

        }
    } catch (err) {
        $YB.error(err);
    }
};

/**
 * Sends '/seek' request.
 *
 * @param {Object} [params] Any parameter specified in this object will be sent along the AJAX request. The API will try to populate every param, so use this only if you need to override a specific param. Refer to the NQS API for more information.
 * @param {function} [callback] If defined, this callback will be called when de AJAX request is done successfully.
 */
$YB.api.Video.prototype.sendSeekEnd = function(params, callback) {
    try {
        if (this.plugin.isJoinSent &amp;&amp; this.plugin.isSeeking) {
            this.plugin.isSeeking = false;

            params = params || {};
            params.duration = typeof params.duration != 'undefined' ? params.duration : this.chrono.seek.getDeltaTime();
            params.time = typeof params.time != 'undefined' ? params.time : this.plugin.infoApi.getPlayhead();

            // Send the request
            this.plugin.comm.sendRequest('/seek', params, callback);
            $YB.notice("Request: NQS /seek " + params.duration + "ms", 'darkgreen');
        }
    } catch (err) {
        $YB.error(err);
    }
};


/** Notifies a Generic Ad start. It will expect a {$YB.api.Video#sendGenericAdEnd}. */
$YB.api.Video.prototype.sendGenericAdStart = function() {
    try {
        if (this.plugin.adnalyzer) {
            $YB.warn('Generic Ads are disabled if an adnalyzer module is loaded.')
        } else {
            if (this.plugin.isStartSent &amp;&amp; !this.plugin.isShowingAds) {
                this.plugin.isShowingAds = true;
                this.chrono.genericAd.start();

                this.sendBufferEnd();
                this.sendSeekEnd();


                $YB.notice("Method: /genericAdStart", 'darkgreen');
            }
        }
    } catch (err) {
        $YB.error(err);
    }
};

/** Notifies a Generic Ad stop.*/
$YB.api.Video.prototype.sendGenericAdEnd = function() {
    try {
        if (this.plugin.adnalyzer) {
            $YB.warn('Generic Ads are disabled if an adnalyzer module is loaded.')
        } else {
            if (this.plugin.isStartSent &amp;&amp; this.plugin.isShowingAds) {
                this.plugin.isShowingAds = false;
                this.chrono.genericAd.stop();

                if (!this.plugin.isJoinSent) { // Remove ad time from joinTime
                    this.chrono.joinTime.startTime += this.chrono.genericAd.getDeltaTime();
                    this.chrono.joinTime.startTime = Math.min(this.chrono.joinTime.startTime, new Date().getTime());
                }

                $YB.notice("Method: /genericAdEnd " + this.chrono.genericAd.getDeltaTime() + "ms", 'darkgreen');
            }
        }
    } catch (err) {
        $YB.error(err);
    }
};
</code></pre>
        </article>
    </section>




    </div>

    <nav>
        <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="$YB.adnalyzers.Generic.html">$YB.adnalyzers.Generic</a></li><li><a href="$YB.api.Ads.html">$YB.api.Ads</a></li><li><a href="$YB.api.Info.html">$YB.api.Info</a></li><li><a href="$YB.api.Ping.html">$YB.api.Ping</a></li><li><a href="$YB.api.Video.html">$YB.api.Video</a></li><li><a href="$YB.comm.AjaxRequest.html">$YB.comm.AjaxRequest</a></li><li><a href="$YB.comm.Communication.html">$YB.comm.Communication</a></li><li><a href="$YB.data.Options.html">$YB.data.Options</a></li><li><a href="$YB.plugins.Generic.html">$YB.plugins.Generic</a></li><li><a href="$YB.services.ResourceParser.html">$YB.services.ResourceParser</a></li><li><a href="$YB.utils.Buffer.html">$YB.utils.Buffer</a></li><li><a href="$YB.utils.Chrono.html">$YB.utils.Chrono</a></li></ul><h3>Namespaces</h3><ul><li><a href="$YB.html">$YB</a></li><li><a href="$YB.adnalyzers.html">$YB.adnalyzers</a></li><li><a href="$YB.api.html">$YB.api</a></li><li><a href="$YB.comm.html">$YB.comm</a></li><li><a href="$YB.data.html">$YB.data</a></li><li><a href="$YB.plugins.html">$YB.plugins</a></li><li><a href="$YB.services.html">$YB.services</a></li><li><a href="$YB.utils.html">$YB.utils</a></li></ul>
    </nav>

    <div class="clear"></div>
    <footer>
        Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Fri Apr 22 2016 09:34:52 GMT+0200 (CEST)
    </footer>

    <script> prettyPrint(); </script>
    <script src="scripts/linenumber.js"> </script>
</body>
</html>