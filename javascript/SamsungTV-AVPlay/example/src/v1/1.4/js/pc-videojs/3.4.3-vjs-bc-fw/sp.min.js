videojs.plugin("youbora",function(params){var player=this;var playerId=this.id();var _options=params;var debug,isLive,bandwidth,_youboraData;try{if(typeof youboraDataMap==="undefined"){_youboraData=youboraData}else{_youboraData=youboraDataMap.get(playerId)}debug=_youboraData.getDebug();isLive=_youboraData.getLive();bandwidth={username:_youboraData.getUsername(),interval:6e3}}catch(e){if(debug){console.log("SmartPlugin :: "+pluginName+" :: bindEvents :: Events atached correctly!")}}var targetDevice="PC-VIDEOJS";var pluginName="VIDEOJS";var pluginVersion="3.4.3-vjs-bc-fw_videojs";if(player.mediainfo){targetDevice="PC-VIDEOJS-BCOVE";pluginName="BCOVE";pluginVersion="3.4.3-vjs-bc-fw_bcovevjs"}var initDone=0;var balanceObject="";var balanceIndex=1;var mediaEvents={BUFFER_BEGIN:1,BUFFER_END:0,JOIN_SEND:2};var videoPlayer=this;var urlResource=undefined;var pingTimer=undefined;var apiClass=undefined;var currentTime=0;var duration=0;var firstTimeUpdate=0;var previousResource="";var liveSetedClient=false;var isStreamError=false;var isBuffering=false;var isStartSent=false;var isJoinSent=false;var isPaused=false;var isAdvertisment=false;var isProgressFired=false;var isCanplayFired=false;var isAdsFired=false;var isAdEndFired=false;var isStalledFired=false;var isLoadedDataFired=false;var isErrorSent=false;var firstResetFired=false;var previousElapsedTime=0;var bufferTimeBegin=0;var joinTimeBegin=0;var joinTimeEnd=0;var startTime=0;var originalResource="";var seeking="";var seekingControlTrigger=false;var seekingControlTime=0;var bufferTimeThreshold=.1;var endSeekDate=0;var endSeekThreshold=500;var bufferCheckTimer={};var bufferTryCount=0;var errors={1:"11100",2:"11101",3:"11102",4:"11103",5:"11104",unknown:"11105","-1":"11106","-2":"11107"};this.youbora={Check:function(){console.log("i am ");console.log(player)},Init:function(){initDone=true;player.youbora.startPlugin()},getYouboraData:function(){return _youboraData},setBcoveProperties:function(options){try{if(!liveSetedClient&&(duration===Infinity||duration<0)){_youboraData.setLive(true)}}catch(e){}try{if(player.mediainfo){if(!options.properties){options.properties=""}if(!options.properties.content_metadata){options.properties={content_metadata:""}}options.properties.content_metadata={title:player.mediainfo.name,duration:player.mediainfo.duration};duration=player.mediainfo.duration}}catch(e){}return options},setProperties:function(options){try{if(options.accountCode){_youboraData.setAccountCode(options.accountCode)}if(options.username){_youboraData.setUsername(options.username)}if(typeof options.isLive!="undefined"){liveSetedClient=true;_youboraData.setLive(options.isLive)}if(options.debug){_youboraData.debug=options.debug;debug=options.debug}if(options.properties){_youboraData.setProperties(options.properties)}if(options.contentId){_youboraData.setContentId(options.contentId)}if(options.transaction){_youboraData.setTransaction(options.transaction)}if(options.httpSecure){_youboraData.setHttpSecure(options.httpSecure)}if(options.isp){_youboraData.setISP(options.isp)}if(options.cdn){_youboraData.setCDN(options.cdn)}if(options.ip){_youboraData.setIP(options.ip)}if(options.CDNNodeData){_youboraData.setCDNNodeData(options.CDNNodeData)}if(options.parseHLS){_youboraData.setParseHLS(options.parseHLS)}if(options.extraparam1){_youboraData.setExtraParam(1,options.extraparam1)}if(options.extraparam2){_youboraData.setExtraParam(2,options.extraparam2)}if(options.extraparam3){_youboraData.setExtraParam(3,options.extraparam3)}if(options.extraparam4){_youboraData.setExtraParam(4,options.extraparam4)}if(options.extraparam5){_youboraData.setExtraParam(5,options.extraparam5)}if(options.extraparam6){_youboraData.setExtraParam(6,options.extraparam6)}if(options.extraparam7){_youboraData.setExtraParam(7,options.extraparam7)}if(options.extraparam8){_youboraData.setExtraParam(8,options.extraparam8)}if(options.extraparam9){_youboraData.setExtraParam(9,options.extraparam9)}if(options.extraparam10){_youboraData.setExtraParam(10,options.extraparam10)}if(options.balanceProperties){options.balanceProperties.enabled=false;_youboraData.setBalanceProperties(options.balanceProperties)}if(options.concurrencyProperties){_youboraData.setConcurrencyProperties(options.concurrencyProperties)}if(options.resumeProperties){_youboraData.setResumeProperties(options.resumeProperties)}if(options.username){bandwidth.username=options.username}}catch(error){if(debug){console.log("SmartPlugin :: "+pluginName+" :: setProperties :: Error: "+error)}}},startPlugin:function(){try{try{videoPlayer=player;duration=player.duration();if(isNaN(duration)||duration=="NaN"||duration==NaN||duration==Infinity){duration=0}if(debug){console.log("SmartPlugin :: "+pluginName+" :: startPlugin :: HTML5 <video> found!")}originalResource=videoPlayer.currentSrc();if(originalResource!=""){_youboraData.setMediaResource(originalResource)}apiClass=new YouboraCommunication(_youboraData.getAccountCode(),_youboraData.getService(),bandwidth,pluginVersion,targetDevice,playerId);player.youbora.bindEvents();if(isPaused){apiClass.sendResume();isPaused=false}if(_youboraData.getBalanceEnabled()&&apiClass.enableBalancer){_youboraData.setBalancedResource(true);if(balanceObject===""){var path=apiClass.getResourcePath(originalResource);apiClass.getBalancedResource(path,function(obj){setBalancedResource(obj)})}}}catch(error){if(debug){console.log(error);console.log("SmartPlugin :: "+pluginName+" :: startPlugin :: No <video> found!")}}}catch(error){if(debug){console.log("SmartPlugin :: "+pluginName+" :: startPlugin :: Error: "+error)}}},bindEvents:function(){try{var playerEvents=["canplay","playing","waiting","timeupdate","ended","play","pause","error","abort","seeking","seeked","stalled","suspend","progress","dispose","loadeddata","loadstart","adstart","adend","select","videoChange"];for(var i=0;i<playerEvents.length;i++){videoPlayer.on(playerEvents[i],function(e){player.youbora.checkPlayState(e)})}player.playlist.on("select",function(e){player.youbora.checkPlayState(e)});player.playlist.on("videoChange",function(e){player.youbora.checkPlayState(e)});window.on("videoChange",function(e){player.youbora.checkPlayState(e)});if(debug){console.log("SmartPlugin :: "+pluginName+" :: bindEvents :: Events atached correctly!")}}catch(error){if(debug){console.log("SmartPlugin :: "+pluginName+" :: bindEvents :: Error: "+error)}}},unbindEvents:function(){try{var playerEvents=["canplay","playing","waiting","timeupdate","ended","play","pause","error","abort","seeking","seeked","stalled","suspend","progress","dispose","loadeddata","loadstart","adstart","adend","select","videoChange"];for(elem in playerEvents){videoPlayer.off(playerEvents[elem],function(e){})}}catch(error){if(debug){console.log("SmartPlugin :: "+pluginName+" :: bindEvents :: Error: "+error)}}},isAd:function(adPlaying){if(debug){console.log("SmartPlugin :: "+pluginName+" :: isAd :: "+adPlaying)}isAdvertisment=adPlaying},isAndroidOrCanPlayFired:function(){if(typeof window.orientation!=="undefined"){if(!isCanplayFired)return false}return true},checkPlayState:function(e){if(debug){console.log("DEBUG: SmartPlugin :: "+pluginName+" :: checkPlayState :: "+e.type)}switch(e.type){case"timeupdate":try{if(isStartSent&&firstTimeUpdate===0&&isCanplayFired){if(joinTimeBegin==0){joinTimeBegin=startTime}firstTimeUpdate=Math.abs((new Date).getTime()-joinTimeBegin)}else if(isStartSent&&firstTimeUpdate!=-1&&(new Date).getTime()-joinTimeBegin>1e4&&isCanplayFired){if(!isAdsFired&&!isJoinSent){isJoinSent=true;isBuffering=false;apiClass.sendJoin(currentTime,firstTimeUpdate);joinTimeBegin=0}firstTimeUpdate=-1}else{if(!isAdvertisment){if(isStartSent&&!isJoinSent&&isAdEndFired&&!seeking&&player.youbora.isAndroidOrCanPlayFired()){player.youbora.setBufferEvent(mediaEvents.BUFFER_END)}urlResource=videoPlayer.currentSrc();currentTime=videoPlayer.currentTime();if(currentTime>0){if(isJoinSent&&previousElapsedTime+bufferTimeThreshold<videoPlayer.currentTime()){player.youbora.checkBuffering()}}}}}catch(error){if(debug){console.log("SmartPlugin :: "+pluginName+" :: timeupdate :: Error: "+error)}}break;case"play":try{if(!isAdvertisment){if(!seeking){urlResource=videoPlayer.currentSrc();duration=videoPlayer.duration();if(!isStartSent&&videoPlayer.error()==null){_youboraData.setMediaResource(videoPlayer.currentSrc());previousResource=videoPlayer.currentSrc();duration=videoPlayer.duration();if(duration===Infinity||duration<0){_youboraData.setLive(true)}if(isNaN(duration)||duration=="NaN"||duration==NaN||duration==Infinity){duration=0}_options=null;startTime=(new Date).getTime();apiClass.sendStart(0,window.location.href,"",_youboraData.getLive(),_youboraData.getMediaResource(),duration,_youboraData.getTransaction());player.youbora.setPing();player.youbora.setBufferChecker();isStartSent=true}if(isPaused){apiClass.sendResume();isPaused=false}}}}catch(error){if(debug){console.log("SmartPlugin :: "+pluginName+" :: play :: Error: "+error)}}break;case"playing":try{if(isStartSent&&!isAdvertisment){isAdsFired=false;if(isPaused){apiClass.sendResume();isPaused=false}}}catch(error){if(debug){console.log("SmartPlugin :: "+pluginName+" :: playing :: Error: "+error)}}break;case"canplay":try{if(isStartSent&&!isAdvertisment){isCanplayFired=true}}catch(error){if(debug){console.log("SmartPlugin :: "+pluginName+" :: canplay :: Error: "+error)}}break;case"adstart":try{isAdsFired=true;player.youbora.isAd(true)}catch(error){if(debug){console.log("SmartPlugin :: "+pluginName+" :: adstart :: Error: "+error)}}break;case"adend":try{isAdEndFired=true;player.youbora.isAd(false);if(!isJoinSent&&!isAdvertisment&&!seeking){this.setBufferEvent(mediaEvents.BUFFER_BEGIN)}}catch(error){if(debug){console.log("SmartPlugin :: "+pluginName+" :: adend :: Error: "+error)}}break;case"pause":try{if(!isAdvertisment&&!seeking&&isStartSent&&isJoinSent){apiClass.sendPause();isPaused=true}}catch(error){if(debug){console.log("SmartPlugin :: "+pluginName+" :: pause :: Error: "+error)}}break;case"ended":try{if(isStartSent&&!isAdvertisment){player.youbora.reset()}}catch(error){if(debug){console.log("SmartPlugin :: "+pluginName+" :: ended :: Error: "+error)}}break;case"abort":try{}catch(error){if(debug){console.log("SmartPlugin :: "+pluginName+" :: abort :: Error: "+error)}}break;case"error":try{_options=player.youbora.setBcoveProperties(_options);if(!isErrorSent){if(_youboraData.getBalanceEnabled()&&apiClass.enableBalancer){if(debug){console.log("SmartPlugin :: "+pluginName+" :: playerError :: Balancing...")}isStreamError=true;apiClass.sendErrorWithParameters("131"+getBalancerErrorCount(),"CDN_PLAY_FAILURE",0,window.location.href,_options,_youboraData.getLive(),balanceObject[balanceIndex]["URL"],videoPlayer.duration());balanceIndex++;player.youbora.refreshBalancedResource()}else{var error="3001";var message="";try{error=videoPlayer.error().code;if(error!==null||error!==undefined){error=errors[error]}if(error==undefined){error="3001"}message=videoPlayer.error().message;if(message===""||message===null){message=videoPlayer.error().type}}catch(e){console.log(e)}isStreamError=true;player.youbora.checkBuffering();clearInterval(pingTimer);if(_youboraData.getMediaResource()===""||_youboraData.getMediaResource()===null){_youboraData.setMediaResource(videoPlayer.currentSrc())}apiClass.sendErrorWithParameters(error,message,0,window.location.href,_options,_youboraData.getLive(),youboraData.getMediaResource(),videoPlayer.duration());player.youbora.reset()}isErrorSent=true}}catch(error){if(debug){console.log("SmartPlugin :: "+pluginName+" :: error :: Error: "+error)}}break;case"progress":try{if(isStartSent){isProgressFired=true}}catch(error){if(debug){console.log("SmartPlugin :: "+pluginName+" :: progress :: Error: "+error)}}break;case"waiting":try{if(!isAdvertisment){if(!seeking){if(isBuffering===false){player.youbora.setBufferEvent(mediaEvents.BUFFER_BEGIN);isBuffering=true}}}}catch(error){if(debug){console.log("SmartPlugin :: "+pluginName+" :: waiting :: Error: "+error)}}break;case"seeking":if(!isAdvertisment&&isStartSent){seeking=true;isBuffering=false;seekingControlTrigger=true;seekingControlTime=(new Date).getTime()}break;case"seeked":if(!isAdvertisment){seeking=false;isBuffering=false}break;case"stalled":try{isStalledFired=true}catch(error){if(debug){console.log("SmartPlugin :: "+pluginName+" :: isStalledFired :: Error: "+error)}}break;case"dispose":player.youbora.unLoad();break;case"loadstart":try{if(!isJoinSent&&!isAdvertisment){this.setBufferEvent(mediaEvents.BUFFER_BEGIN)}}catch(error){if(debug){console.log("SmartPlugin :: "+pluginName+" :: playing :: Error: "+error)}}break;case"loadeddata":try{}catch(error){if(debug){console.log("SmartPlugin :: "+pluginName+" :: loadeddata :: Error: "+error)}}break;case"select":case"videoChange":try{}catch(error){if(debug){console.log("SmartPlugin :: "+pluginName+" :: loadeddata :: Error: "+error)}}break;case"buffered":break;case"bufferedEnd":break;default:break}},setBufferChecker:function(){bufferCheckTimer=setTimeout(function(){player.youbora.bufferChecker()},300)},bufferChecker:function(){try{if(videoPlayer.currentTime()>0&&!isBuffering&&!isPaused&&!seeking){var now=(new Date).getTime();if(previousElapsedTime>=videoPlayer.currentTime()&&videoPlayer.currentTime()<videoPlayer.duration()){bufferTryCount++;if(bufferTryCount>=2){player.youbora.setBufferEvent(mediaEvents.BUFFER_BEGIN);isBuffering=true;bufferTryCount=0}}}}catch(e){console.log(e)}clearTimeout(bufferCheckTimer);previousElapsedTime=videoPlayer.currentTime();player.youbora.setBufferChecker()},getBalancerErrorCount:function(){if(balanceIndex<10){return"0"+balanceIndex}else if(balanceIndex>10){return balanceIndex}else{return"00"}},refreshBalancedResource:function(){try{if(typeof balanceObject[balanceIndex]!="undefined"){videoPlayer.src(balanceObject[balanceIndex]["URL"]);setTimeout(function(){videoPlayer.load()},50);videoPlayer.load()}else{_youboraData.setBalanceEnabled(false);videoPlayer.src(originalResource);setTimeout(function(){videoPlayer.load()},50);if(debug){console.log("SmartPlugin :: "+pluginName+" :: Balancer :: End of mirrors")}}}catch(error){if(debug){console.log("SmartPlugin :: "+pluginName+" :: Balancer :: Error :: End of mirrors error:"+error)}}},setBalancedResource:function(obj){try{if(obj!==false){var indexCount=0;for(index in obj){indexCount++}balanceObject=obj;balanceObject[""+(indexCount+1)+""]=new Object;balanceObject[""+(indexCount+1)+""]["URL"]=_youboraData.getMediaResource();if(typeof obj["1"]["URL"]!="undefined"){if(debug){console.log("SmartPlugin :: "+pluginName+" :: Balance Current Resource  :: "+urlResource);console.log("SmartPlugin :: "+pluginName+" :: Balance Priority Resource :: "+obj["1"]["URL"])}if(obj["1"]["URL"]!=originalResource){if(debug){console.log("SmartPlugin :: "+pluginName+" :: Balancing :: "+obj["1"]["URL"])}try{videoPlayer.src(obj["1"]["URL"]);_youboraData.setCDN(obj["1"]["CDN_CODE"]);videoPlayer.pause();videoPlayer.load()}catch(error){if(debug){console.log("SmartPlugin :: "+pluginName+" :: Balancing :: Error While Changing Media: "+error)}videoPlayer.src(obj["1"]["URL"]);videoPlayer.load()}}else{if(debug){console.log("SmartPlugin :: "+pluginName+" :: Balancer :: Same Resource")}_youboraData.setBalanceEnabled(false);videoPlayer.src(originalResource);videoPlayer.load()}}else{if(debug){console.log("SmartPlugin :: "+pluginName+" :: Invalid balance object")}videoPlayer.load()}}else{if(debug){console.log("SmartPlugin :: "+pluginName+" :: Balance unavailable with current parameters")}balanceObject="false";videoPlayer.load()}}catch(error){if(debug){console.log("SmartPlugin :: "+pluginName+" :: setBalancedResource :: Error: "+error)}}},checkBuffering:function(){try{if(isBuffering&&isStartSent&&isJoinSent&&!isAdvertisment){if(!isAdsFired){player.youbora.setBufferEvent(mediaEvents.BUFFER_END)}bufferTryCount=0;isBuffering=false}}catch(error){if(debug){console.log("SmartPlugin :: "+pluginName+" :: checkBuffering :: Error: "+error)}}},setBufferEvent:function(bufferState){try{var d=new Date;var bufferTimeEnd=0;var bufferTimeTotal=0;switch(bufferState){case mediaEvents.BUFFER_BEGIN:bufferTimeBegin=d.getTime();if(joinTimeBegin===0){joinTimeBegin=d.getTime()}break;case mediaEvents.BUFFER_END:bufferTimeEnd=d.getTime();if(bufferTimeBegin==0){bufferTimeBegin=startTime;startTime=0}bufferTimeTotal=bufferTimeEnd-bufferTimeBegin;if(isJoinSent==false){if(isStartSent){apiClass.sendJoin(currentTime,bufferTimeTotal);joinTimeBegin=0;isJoinSent=true}if(debug){console.log("SmartPlugin :: "+pluginName+" :: setBufferEvent :: sendJoin")}}else{var seekingControlTimeEnd=(new Date).getTime();if(!seekingControlTrigger||seekingControlTrigger&&seekingControlTimeEnd-seekingControlTime>1e4){if(currentTime===0&&isLive){currentTime=10}if(seeking){if(debug){console.log("SmartPlugin :: "+pluginName+" :: setBufferEvent :: sendSeek")}}else{if(isStartSent&&bufferTimeTotal>=100){apiClass.sendBuffer(currentTime,bufferTimeTotal)}if(debug){console.log("SmartPlugin :: "+pluginName+" :: setBufferEvent :: sendBuffer")}}}seekingControlTrigger=false;seekingControlTime=0;seekingControlTimeEnd=0}isBuffering=false;break;default:break}}catch(error){if(debug){console.log("SmartPlugin :: "+pluginName+" :: setBufferEvent :: Error: "+error)}}},setPing:function(){try{pingTimer=setTimeout(function(){player.youbora.ping()},apiClass.getPingTime())}catch(error){if(debug){console.log("SmartPlugin :: "+SmartPlugin.pluginName+" :: setPing :: Error: "+error)}}},ping:function(){try{clearTimeout(pingTimer);var bitrate=this.getCurrentBitrate();var bandwidth=this.getCurrentBandwidth();pingTimer=null;player.youbora.setPing();if(isStartSent){apiClass.sendPingTotalBitrate(bitrate,currentTime)}}catch(error){if(debug){console.log("SmartPlugin :: "+pluginName+" :: Ping :: Error: "+error)}}},getCurrentBitrate:function(){try{if(player.hls){return player.hls.playlists.media().attributes.BANDWIDTH}else{return-1}}catch(error){if(debug){console.log("SmartPlugin :: "+pluginName+" :: getCurrentBitrate :: Error: "+error)}}},getCurrentBandwidth:function(){try{if(player.hls){return player.hls.bandwidth}else{return-1}}catch(error){if(debug){console.log("SmartPlugin :: "+pluginName+" :: getCurrentBandwidth :: Error: "+error)}}},defineWatch:function(){try{if(!Object.prototype.watch){Object.defineProperty(Object.prototype,"watch",{enumerable:false,configurable:true,writable:false,value:function(prop,handler){var oldval=this[prop],newval=oldval,getter=function(){return newval},setter=function(val){oldval=newval;return newval=handler.call(this,prop,oldval,val)};if(delete this[prop]){Object.defineProperty(this,prop,{get:getter,set:setter,enumerable:true,configurable:true})}}})}if(!Object.prototype.unwatch){Object.defineProperty(Object.prototype,"unwatch",{enumerable:false,configurable:true,writable:false,value:function(prop){var val=this[prop];delete this[prop];this[prop]=val}})}setWatch()}catch(error){if(debug){console.log("SmartPlugin :: "+pluginName+" :: defineWatch :: Error: "+error)}}},setWatch:function(){try{var varsToWatch=["balanceObject","balanceIndex","videoPlayer","urlResource","currentTime","isStreamError","isBuffering","isStartSent","isJoinSent","isPaused","bufferTimeBegin","joinTimeBegin","joinTimeEnd"];for(elem in varsToWatch){if(typeof varsToWatch[elem]!="function"){watch(varsToWatch[elem],function(id,oldVal,newVal){console.log("SmartPlugin :: "+pluginName+" :: Watcher :: ["+id+"] From: ["+oldVal+"] To: ["+newVal+"]");return newVal})}}}catch(error){if(debug){console.log("SmartPlugin :: "+pluginName+" :: setWatch :: Error: "+error)}}},reset:function(){try{isLoadedDataFired=false;isCanplayFired=false;isProgressFired=false;isAdEndFired=false;clearTimeout(pingTimer);clearTimeout(bufferCheckTimer);if(isStartSent){apiClass.sendStop()}else{apiClass.reset()}currentTime=0;urlResource="";isLive=_youboraData.getLive();duration=0;previousElapsedTime=0;isPaused=false;isStartSent=false;seeking=false;bufferTimeBegin=0;isJoinSent=false;joinTimeEnd=0;pingTimer="";balanceIndex=1;balanceObject="";isStalledFired=false;isErrorSent=false;isAdsFired=false;firstTimeUpdate=0;joinTimeBegin=0}catch(error){if(debug){console.log("SmartPlugin :: "+pluginName+" :: reset :: Error: "+error)}}},unLoad:function(){try{clearTimeout(pingTimer);clearTimeout(bufferCheckTimer);apiClass.sendStop();currentTime=0;urlResource="";isLive=_youboraData.getLive();duration=0;previousElapsedTime=0;isPaused=false;isStartSent=false;isAdEndFired=false;bufferTimeBegin=0;isJoinSent=false;joinTimeBegin=0;joinTimeEnd=0;pingTimer="";balanceIndex=1;balanceObject="";unbindEvents();seeking="";previousResource="";isErrorSent=false;delete apiClass}catch(error){if(debug){console.log("SmartPlugin :: "+pluginName+" :: reset :: Error: "+error)}}}};if(typeof YouboraCommunication!="undefined"&&_youboraData!="undefined"){player.youbora.setProperties(_options);player.youbora.Init()}});
